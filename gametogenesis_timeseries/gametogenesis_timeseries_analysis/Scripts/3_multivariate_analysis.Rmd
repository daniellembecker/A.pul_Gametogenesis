---
title: "Multivariate analysis of gametogenesis physiological, reproductive, and environmental data"
author: "DM Becker"
date: "20240709"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

# Set Up    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
if (!require("lme4")) install.packages("lme4")
if (!require("lmerTest")) install.packages("lmerTest")
if (!require("car")) install.packages("car")
if (!require("effects")) install.packages("effects")
if (!require("ggfortify")) install.packages("ggfortify")
if (!require("cowplot")) install.packages("cowplot")
if (!require("vegan")) install.packages("vegan")
if (!require("corrr")) install.packages("corrr")
if (!require("ggcorrplot")) install.packages("ggcorrplot")
if (!require("GGally")) install.packages("GGally")
if (!require("broom")) install.packages("broom")
if (!require("cowplot")) install.packages("cowplot")
# Install devtools if not already installed
if (!require("devtools")) install.packages("devtools")
# Load devtools
library(devtools)
# Install pairwiseAdonis from GitHub
devtools::install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")
if (!require("corrplot")) install.packages("corrplot")
if (!require("dplyr")) install.packages("dplyr")
if (!require("mctest")) install.packages("mctest")
if (!require("ordinal")) install.packages("ordinal")

# load packages
library(tidyverse)
library(lmtest)
library(ordinal)
library(ggrepel)
library(mctest)
library(MASS)
library(VGAM)
library(brant)
library(plyr)
library(corrplot)
library(ggplot2)
library(RColorBrewer)
library(lme4)
library(lmerTest)
library(car)
library(lubridate)
library(effects)
library(ggfortify)
library(cowplot)
library(vegan)
library(dplyr)
library(corrr)
library(ggcorrplot)
library(GGally)
library(broom)
library(cowplot)
library(patchwork)
library(pairwiseAdonis)
```

# Load dataframe

Use univariate analyses plots for main figure, comment this out for now if we want dot plots with mean se
Load in master data frames for environmental, physiological, and reproductive data 
```{r}
# master<-read.csv("gametogenesis_timeseries_analysis/Output/master_timeseries.csv")
```

# Aggregate and rename physioloigcal data
```{r}
# # Assuming phys_data is already filtered and renamed correctly
# phys_data <- master %>%
#   dplyr::select(colony_id, timepoint, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Total_Chl_cm2, host_prot_mg.cm2, holobiont_prot_mg.cm2, cells.cm2) %>%
#   filter(Host_AFDW.mg.cm2 > 0) %>%
#   filter(Sym_AFDW.mg.cm2 > 0) %>%
#   dplyr::rename(
#     Host_Biomass = Host_AFDW.mg.cm2,
#     Symbiont_Biomass = Sym_AFDW.mg.cm2,
#     Symbiont_Density = cells.cm2,
#     Host_Protein = host_prot_mg.cm2,
#     Holobiont_Protein = holobiont_prot_mg.cm2,
#     Total_Chlorophyll = Total_Chl_cm2)
# 
# # Ensure timepoint is a factor with appropriate levels
# phys_data$timepoint <- factor(phys_data$timepoint, levels = unique(phys_data$timepoint))
# 
# # Calculate IQR for Total_Chlorophyll due to outliers
# Q1 <- quantile(phys_data$Total_Chlorophyll, 0.25, na.rm = TRUE)
# Q3 <- quantile(phys_data$Total_Chlorophyll, 0.75, na.rm = TRUE)
# IQR <- Q3 - Q1
# 
# # Define bounds for outliers
# lower_bound <- Q1 - 1.5 * IQR
# upper_bound <- Q3 + 1.5 * IQR
# 
# # Remove outliers
# phys_data_cleaned <- phys_data %>%
#   filter(Total_Chlorophyll >= lower_bound & Total_Chlorophyll <= upper_bound)
# 
# # Remove August ACR-426 datapoint from the cleaned data for host protein due to outlier
# phys_data_cleaned <- phys_data_cleaned %>%
#   filter(!(timepoint == "AUGUST" & colony_id == "ACR-426"))
# 
# # Calculate mean, se and SD per timepoint
# summary_data <- do.call(rbind, by(phys_data_cleaned, phys_data_cleaned$timepoint, function(x) {
#   n <- nrow(x)  # Sample size
#   
#   calculate_stats <- function(var) {
#     mean_val <- mean(var, na.rm = TRUE)
#     sd_val <- sd(var, na.rm = TRUE)
#     se_val <- sd_val / sqrt(n)
#     return(c(mean = mean_val, sd = sd_val, se = se_val))}
#   
#   stats_list <- list(
#     Host_Biomass = calculate_stats(x$Host_Biomass),
#     Symbiont_Biomass = calculate_stats(x$Symbiont_Biomass),
#     Total_Chlorophyll = calculate_stats(x$Total_Chlorophyll),
#     Host_Protein = calculate_stats(x$Host_Protein),
#     Holobiont_Protein = calculate_stats(x$Holobiont_Protein),
#     Symbiont_Density = calculate_stats(x$Symbiont_Density))
#   
#   result <- data.frame(timepoint = unique(x$timepoint))
#   for (var in names(stats_list)) {
#     result[[paste0(var, "_mean")]] <- stats_list[[var]]["mean"]
#     result[[paste0(var, "_sd")]] <- stats_list[[var]]["sd"]
#     result[[paste0(var, "_se")]] <- stats_list[[var]]["se"]}
#   
#   return(result)}))
# 
# # Convert row names to a column if needed
# summary_data$timepoint <- rownames(summary_data)
# rownames(summary_data) <- NULL
# 
# # Set the timepoint factor levels in the correct order
# summary_data$timepoint <- factor(summary_data$timepoint, 
#                                   levels = c("JANUARY", "FEBRUARY", "MARCH", 
#                                              "APRIL", "MAY", "JUNE", 
#                                              "JULY", "AUGUST", "SEPTEMBER", 
#                                              "OCTOBER"))
```

# Load in histological data
```{r}
#load histo data
oogen_abundance <- read.csv("gametogenesis_timeseries_analysis/Output/oocyte_abun_data.csv")[-1]
  
sperm_abundance <- read.csv("gametogenesis_timeseries_analysis/Output/sperm_abun_data.csv")[-1]

oogen_size <- read.csv("gametogenesis_timeseries_analysis/Output/oogen_size_data.csv")[-1]
  
sperm_size <- read.csv("gametogenesis_timeseries_analysis/Output/sperm_size_data.csv")[-1]

```

# Load in light and temperature data
```{r}
light.dat <- read.csv("../RAnalysis/output/environmental/mahana_light_data.csv")[, -1]

temp.dat <- read.csv("gametogenesis_timeseries_analysis/Output/mean_temp_data.csv")[, -1]

```

# Load in physiological data
```{r}
master <- read.csv("gametogenesis_timeseries_analysis/Output/master_timeseries.csv")

# read in metadata to add patch to master timeseries
metadata <- read.csv("gametogenesis_timeseries_analysis/master_metadata.csv")

# add ACR- before each tag number
metadata <- metadata %>%
  mutate(colony_id = paste0("ACR-", colony_id))

#commbine master and metadata
master <- left_join(master, metadata)
```

<!-- Create downstream plots to use in fully combined figure -->
<!-- Smoothed temperature plot -->
<!-- ```{r} -->
<!-- # Convert date.time to POSIXct format -->
<!-- temp.dat$date.time <- as.POSIXct(temp.dat$date.time, format="%Y-%m-%d %H:%M", tz="UTC") -->

<!-- #filter to not show november  -->
<!-- temp.dat <- temp.dat %>% -->
<!--   filter(month != "Nov") -->

<!-- # Smoothed temperature plot across time -->
<!-- temp_summary_plot <- temp.dat %>% -->
<!--   ggplot(., aes(x=date.time, y= temp)) +  -->
<!--   geom_point(colour="gray", size=0.5, alpha=0.05) +  -->
<!--   geom_smooth(aes(), se=FALSE, method="gam", colour = "black") +  -->
<!--   ylab("Temperature Â°C") +  -->
<!--   xlab("") + -->
<!--   scale_x_datetime(date_breaks = "1 months", date_labels = "%b %Y")+ -->
<!--   theme_classic() +  -->
<!--   theme( -->
<!--     text=element_text(size=14, colour="black"),  -->
<!--     axis.title=element_text(size=18, colour="black", face="bold"),  -->
<!--     axis.text.x = element_blank(), # Hide x-axis text labels -->
<!--     legend.title=element_text(size=18, colour="black", face="bold")) + -->
<!--       ylim(25, 30);temp_summary_plot -->

<!-- ``` -->


<!-- Smoothed light plot  -->
<!-- ```{r} -->
<!-- # Combine Date and Time columns into a new column named DateTime -->
<!-- light.dat$DateTime <- with(light.dat, ymd_hms(paste(Date, Time))) -->

<!-- light_summary_plot <- light.dat %>% -->
<!--   ggplot(aes(x = DateTime, y = calibrated)) +  -->
<!--   geom_point(colour = "darkgray", size = 0.5, alpha = 0.05) +  -->
<!--   geom_smooth(se = FALSE, colour = "black") +  -->
<!--   ylab(expression("Light Intensity " * (mu*mol~m^{-2}~s^{-1}))) + -->
<!--   xlab("") + # This will set the x-axis label but you can remove this line if you want to remove the x-axis title -->
<!--   scale_x_datetime(date_breaks = "1 months", date_labels = "%b %Y") + -->
<!--   theme_classic() +  -->
<!--   theme(text=element_text(size=14, colour="black"),  -->
<!--     axis.title=element_text(size=18, colour="black", face="bold"),  -->
<!--     axis.text.x = element_blank(), # Hide x-axis text labels -->
<!--     legend.title=element_text(size=18, colour="black", face="bold")) + -->
<!--   scale_y_continuous(expand = c(0, 0)) + -->
<!--   coord_cartesian(ylim = c(1000, 6000));light_summary_plot -->

<!-- ``` -->

<!-- Physiological variable plots -->
<!-- Symbiont densities -->
<!-- ```{r} -->
<!-- # Symbiont densities plot -->
<!-- sym <- ggplot(summary_data, aes(x = timepoint, y = Symbiont_Density_mean)) + -->
<!--   geom_point(size = 3, color = "black") + -->
<!--   geom_errorbar(aes(ymin = Symbiont_Density_mean - Symbiont_Density_se, ymax = Symbiont_Density_mean + Symbiont_Density_se), width = 0.2, color = "black") + -->
<!--   xlab("") + -->
<!--   ylab(expression(bold(paste("Symbiont Densities cm"^-2)))) + -->
<!--   theme_minimal() + -->
<!--   theme( -->
<!--     legend.position = "none", -->
<!--     axis.title = element_text(face = "bold", size = 20), -->
<!--     axis.text.x = element_blank(),         # Remove x-axis text labels -->
<!--     axis.ticks.x = element_blank(),        # Remove x-axis ticks -->
<!--     axis.text.y = element_text(size = 20, color = "black"), # Y-axis text labels -->
<!--     axis.ticks.y = element_line(color = "black"), # Y-axis ticks -->
<!--     strip.text.x = element_text(face = "italic", size = 20), -->
<!--     panel.grid.major = element_blank(),    # Remove major gridlines -->
<!--     panel.grid.minor = element_blank(),    # Remove minor gridlines -->
<!--     panel.border = element_blank(),        # Remove panel border -->
<!--     axis.line = element_line(color = "black")) -->

<!-- ``` -->

<!-- Chlorophyll plot -->
<!-- ```{r} -->
<!-- # Plot for Total Chlorophyll -->
<!-- chl <- ggplot(summary_data, aes(x = timepoint, y = Total_Chlorophyll_mean)) + -->
<!--   geom_point(size = 3, color = "black") + -->
<!--   geom_errorbar(aes(ymin = Total_Chlorophyll_mean - Total_Chlorophyll_se, ymax = Total_Chlorophyll_mean + Total_Chlorophyll_se), width = 0.2, color = "black") + -->
<!--   geom_smooth(method = "lm", color = "blue", se = FALSE, linetype = "solid") +  # Adding a linear trendline -->
<!--   xlab("") + -->
<!--   ylab(expression(bold(paste("Total Chlorophyll (", mu, "g cm"^-2, ")")))) +  # y-axis label with Greek letter -->
<!--   theme_minimal() + -->
<!--   theme( -->
<!--     legend.position = "none", -->
<!--     axis.title = element_text(face = "bold", size = 20), -->
<!--     axis.text.x = element_blank(),         # Remove x-axis text labels -->
<!--     axis.ticks.x = element_blank(),        # Remove x-axis ticks -->
<!--     axis.text.y = element_text(size = 20, color = "black"), # Y-axis text labels -->
<!--     axis.ticks.y = element_line(color = "black"), # Y-axis ticks -->
<!--     strip.text.x = element_text(face = "italic", size = 20), -->
<!--     panel.grid.major = element_blank(),    # Remove major gridlines -->
<!--     panel.grid.minor = element_blank(),    # Remove minor gridlines -->
<!--     panel.border = element_blank(),        # Remove panel border -->
<!--     axis.line = element_line(color = "black"))  # Add axis lines -->

<!-- ``` -->

<!-- Symbiont biomass -->
<!-- ```{r} -->
<!-- # Plot for Symbiont Biomass -->
<!-- sym.bio <- ggplot(summary_data, aes(x = timepoint, y = Symbiont_Biomass_mean)) + -->
<!--   geom_point(size = 3, color = "black") + -->
<!--   geom_errorbar(aes(ymin = Symbiont_Biomass_mean - Symbiont_Biomass_se, ymax = Symbiont_Biomass_mean + Symbiont_Biomass_se), width = 0.2, color = "black") + -->
<!--   geom_smooth(method = "lm", color = "blue", se = FALSE, linetype = "solid") +  # Adding a linear trendline -->
<!--   xlab("") + -->
<!--   ylab(expression(bold(paste("Symbiont Biomass (mg cm"^-2, ")")))) + -->
<!--   theme_minimal() + -->
<!--   theme( -->
<!--     legend.position = "none", -->
<!--     axis.title = element_text(face = "bold", size = 20), -->
<!--     axis.text.x = element_blank(),         # Remove x-axis text labels -->
<!--     axis.ticks.x = element_blank(),        # Remove x-axis ticks -->
<!--     axis.text.y = element_text(size = 20, color = "black"), # Y-axis text labels -->
<!--     axis.ticks.y = element_line(color = "black"), # Y-axis ticks -->
<!--     strip.text.x = element_text(face = "italic", size = 20), -->
<!--     panel.grid.major = element_blank(),    # Remove major gridlines -->
<!--     panel.grid.minor = element_blank(),    # Remove minor gridlines -->
<!--     panel.border = element_blank(),        # Remove panel border -->
<!--     axis.line = element_line(color = "black"))  # Add axis lines -->

<!-- ``` -->

<!-- Host biomass -->
<!-- ```{r} -->
<!-- # Plot for Host Biomass -->
<!-- host.bio <- ggplot(summary_data, aes(x = timepoint, y = Host_Biomass_mean)) + -->
<!--   geom_point(size = 3, color = "black") + -->
<!--   geom_errorbar(aes(ymin = Host_Biomass_mean - Host_Biomass_se, ymax = Host_Biomass_mean + Host_Biomass_se), width = 0.2, color = "black") + -->
<!--   geom_smooth(method = "lm", color = "blue", se = FALSE, linetype = "solid") +  # Adding a linear trendline -->
<!--   xlab("") + -->
<!--   ylab(expression(bold(paste("Host Biomass (mg cm"^-2, ")")))) + -->
<!--   theme_minimal() + -->
<!--   theme( -->
<!--     legend.position = "none", -->
<!--     axis.title = element_text(face = "bold", size = 20), -->
<!--     axis.text.x = element_blank(),         # Remove x-axis text labels -->
<!--     axis.ticks.x = element_blank(),        # Remove x-axis ticks -->
<!--     axis.text.y = element_text(size = 20, color = "black"), # Y-axis text labels -->
<!--     axis.ticks.y = element_line(color = "black"), # Y-axis ticks -->
<!--     strip.text.x = element_text(face = "italic", size = 20), -->
<!--     panel.grid.major = element_blank(),    # Remove major gridlines -->
<!--     panel.grid.minor = element_blank(),    # Remove minor gridlines -->
<!--     panel.border = element_blank(),        # Remove panel border -->
<!--     axis.line = element_line(color = "black"))  # Add axis lines -->

<!-- ``` -->


<!-- Host protein -->
<!-- ```{r} -->
<!-- # Host protein -->
<!-- host_protein <- ggplot(summary_data, aes(x = timepoint, y = Host_Protein_mean)) + -->
<!--   geom_point(size = 3, color = "black") + -->
<!--   geom_errorbar(aes(ymin = Host_Protein_mean - Host_Protein_se, ymax = Host_Protein_mean + Host_Protein_se), width = 0.2, color = "black") + -->
<!--   geom_smooth(method = "lm", color = "blue", se = FALSE, linetype = "solid") +  # Adding a linear trendline -->
<!--   xlab("") + -->
<!--   ylab(expression(bold(paste("Host Protein (mg cm"^-2, ")")))) + -->
<!--   theme_minimal() + -->
<!--   theme( -->
<!--     legend.position = "none", -->
<!--     axis.title = element_text(face = "bold", size = 20), -->
<!--     axis.text.x = element_blank(),         # Remove x-axis text labels -->
<!--     axis.ticks.x = element_blank(),        # Remove x-axis ticks -->
<!--     axis.text.y = element_text(size = 20, color = "black"), # Y-axis text labels -->
<!--     axis.ticks.y = element_line(color = "black"), # Y-axis ticks -->
<!--     strip.text.x = element_text(face = "italic", size = 20), -->
<!--     panel.grid.major = element_blank(),    # Remove major gridlines -->
<!--     panel.grid.minor = element_blank(),    # Remove minor gridlines -->
<!--     panel.border = element_blank(),        # Remove panel border -->
<!--     axis.line = element_line(color = "black"))  # Add axis lines -->

<!-- ``` -->


<!-- Holobiont protein -->
<!-- ```{r} -->
<!-- # Plot for Holobiont Protein -->
<!-- holo_protein <- ggplot(summary_data, aes(x = timepoint, y = Holobiont_Protein_mean)) + -->
<!--   geom_point(size = 3, color = "black") + -->
<!--   geom_errorbar(aes(ymin = Holobiont_Protein_mean - Holobiont_Protein_se, ymax = Holobiont_Protein_mean + Holobiont_Protein_se), width = 0.2, color = "black") + -->
<!--   geom_smooth(method = "lm", color = "blue", se = FALSE, linetype = "solid") +  # Adding a linear trendline -->
<!--   xlab("") + -->
<!--   ylab(expression(bold(paste("Holobiont Protein (mg cm"^-2, ")")))) + -->
<!--   theme_minimal() + -->
<!--   theme( -->
<!--     legend.position = "none", -->
<!--     axis.title = element_text(face = "bold", size = 20), -->
<!--     axis.text.x = element_blank(),         # Remove x-axis text labels -->
<!--     axis.ticks.x = element_blank(),        # Remove x-axis ticks -->
<!--     axis.text.y = element_text(size = 20, color = "black"), # Y-axis text labels -->
<!--     axis.ticks.y = element_line(color = "black"), # Y-axis ticks -->
<!--     strip.text.x = element_text(face = "italic", size = 20), -->
<!--     panel.grid.major = element_blank(),    # Remove major gridlines -->
<!--     panel.grid.minor = element_blank(),    # Remove minor gridlines -->
<!--     panel.border = element_blank(),        # Remove panel border -->
<!--     axis.line = element_line(color = "black"))  # Add axis lines -->

<!-- ``` -->


<!-- ```{r} -->
<!-- # Customize environmental and physiological plots to remove x-axis labels and ticks except for the bottom plot -->
<!-- temp_summary_plot <- temp_summary_plot + theme(axis.title.x = element_blank(),  -->
<!--                                      axis.text.x = element_blank(),  -->
<!--                                      axis.ticks.x = element_blank(), -->
<!--                                      axis.title=element_text(face="bold", size=18), -->
<!--                                      axis.text=element_text(size=18, color="black")) -->

<!-- light_summary_plot <- light_summary_plot + theme(axis.title.x = element_blank(),  -->
<!--                                    axis.text.x = element_blank(),  -->
<!--                                    axis.ticks.x = element_blank(), -->
<!--                                    axis.title=element_text(face="bold", size=18), -->
<!--                                    axis.text=element_text(size=18, color="black")) -->

<!-- symbplot_cm2 <- symbplot_cm2 + theme(axis.title.x = element_blank(),  -->
<!--                                      axis.text.x = element_blank(),  -->
<!--                                      axis.ticks.x = element_blank(), -->
<!--                                      axis.title=element_text(face="bold", size=18), -->
<!--                                      axis.text=element_text(size=18, color="black")) -->

<!-- sym_bio_cm2 <- sym_bio_cm2 + theme(axis.title.x = element_blank(),  -->
<!--                                    axis.text.x = element_blank(),  -->
<!--                                    axis.ticks.x = element_blank(), -->
<!--                                      axis.title=element_text(face="bold", size=18), -->
<!--                                      axis.text=element_text(size=18, color="black")) -->

<!-- tot.chl <- tot.chl + theme(axis.title.x = element_blank(),  -->
<!--                            axis.text.x = element_blank(),  -->
<!--                            axis.ticks.x = element_blank(), -->
<!--                            axis.title=element_text(face="bold", size=18), -->
<!--                            axis.text=element_text(size=18, color="black")) -->

<!-- host_prot_cm2 <- host_prot_cm2 + theme(axis.title.x = element_blank(),  -->
<!--                                        axis.text.x = element_blank(),  -->
<!--                                        axis.ticks.x = element_blank(), -->
<!--                                        axis.title=element_text(face="bold", size=18), -->
<!--                                        axis.text=element_text(size=18, color="black")) -->


<!-- holobiont_prot_cm2 <- holobiont_prot_cm2 + theme(axis.title.x = element_blank(),  -->
<!--                                                  axis.text.x = element_blank(),  -->
<!--                                                  axis.ticks.x = element_blank(), -->
<!--                                                  axis.title=element_text(face="bold", size=18), -->
<!--                                                  axis.text=element_text(size=18, color="black")) -->

<!-- host_bio_cm2 <- host_bio_cm2 + theme(axis.title=element_text(face="bold", size=18), -->
<!--                                                  axis.text=element_text(size=18, color="black")) -->

<!-- # Leave the x-axis labels and ticks for the last plot (host_bio_cm2) -->
<!-- # No changes needed for host_bio_cm2 as it will display the x-axis -->

<!-- # Combine the physiological and environmmental plots (with x-axis labels only on the bottom plot) -->
<!-- combined_plot <- (temp_summary_plot / light_summary_plot / symbplot_cm2 / sym_bio_cm2 / tot.chl / host_prot_cm2 / holobiont_prot_cm2 / host_bio_cm2) + -->
<!--   plot_layout(ncol = 1, guides = 'collect') -->

<!-- # Save combined plot -->
<!-- ggsave(filename="gametogenesis_timeseries_analysis/Figures/timeseries_stacked_plot.png", plot=combined_plot, dpi=300, width=10, height=20, units="in") -->
<!-- ``` -->


<!-- Run models to look at individual impacts of physio on frequency in stage -->
<!-- ```{r} -->
<!-- # Define the custom function -->
<!-- to_title_case <- function(x) { -->
<!--   gsub("(^|[[:space:]])([[:alpha:]])", "\\1\\U\\2", tolower(x), perl = TRUE) -->
<!-- } -->

<!-- # make timepoints numbered -->
<!-- master_select <- master %>% -->
<!--   mutate(timepoint = to_title_case(timepoint)) %>% -->
<!--   mutate(Month_Number = case_when( -->
<!--     timepoint == "January" ~ 1, -->
<!--     timepoint == "February" ~ 2, -->
<!--     timepoint == "March" ~ 3, -->
<!--     timepoint == "April" ~ 4, -->
<!--     timepoint == "May" ~ 5, -->
<!--     timepoint == "June" ~ 6, -->
<!--     timepoint == "July" ~ 7, -->
<!--     timepoint == "August" ~ 8, -->
<!--     timepoint == "September" ~ 9, -->
<!--     timepoint == "October" ~ 10, -->
<!--     TRUE ~ NA_integer_))  %>%  -->
<!--   dplyr::select(colony_id, Month_Number, timepoint, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Total_Chl_cm2, host_prot_mg.cm2, holobiont_prot_mg.cm2, cells.cm2) -->

<!-- # get the means per timepoint for all these physiological variables -->
<!-- master_means <- master_select %>% -->
<!--   group_by(timepoint, Month_Number) %>% -->
<!--   dplyr::summarise(across(c(Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Total_Chl_cm2,  -->
<!--                      host_prot_mg.cm2, holobiont_prot_mg.cm2, cells.cm2),  -->
<!--                    list(mean = ~mean(., na.rm = TRUE), -->
<!--                         se = ~sd(., na.rm = TRUE) / sqrt(n()))), -->
<!--             .groups = "drop") %>% -->
<!--   arrange(Month_Number) -->


<!-- all.dat <- left_join(master_means, oogen_abundance) -->

<!-- ``` -->


Calculate the condition indices and variance-decomposition proportions for each physiological (explanatory) variable for multicollinearity analysis
```{r}
# Create the subset for the specified variables
subset_dataframe <- master %>%
  dplyr::select(Sym_AFDW.mg.cm2, 
         Total_Chl_cm2, 
         cells.cm2)

# Replace Total_Chl_cm2 values with NA for June due to higher abs values not explained by other biological response variables, could be an artifact in the lab processing
#subset_dataframe <- subset_dataframe %>%
 # mutate(Total_Chl_cm2 = ifelse(master$timepoint == "JUNE", NA, Total_Chl_cm2))

# Calculate the correlation matrix
correlation_matrix <- cor(subset_dataframe, use = "pairwise.complete.obs")

# Print the correlation matrix
print(correlation_matrix)

# Fit a linear model with all variables
model <- lm(Sym_AFDW.mg.cm2 ~ ., data = subset_dataframe)

# Calculate eigenvalues, condition indices, and variance decomposition proportions
multicollinearity_diagnostics <- eigprop(model)

# Print the results
print(multicollinearity_diagnostics)

#VIF values above 5 (or 10) suggest multicollinearity may be problematic.
vif_values <- vif(model)
print(vif_values)


```
Call:
eigprop(mod = model)

  Eigenvalues     CI (Intercept) Total_Chl_cm2 cells.cm2
1      2.8045 1.0000      0.0142        0.0162    0.0197
2      0.1183 4.8693      0.0533        0.3592    0.9009
3      0.0772 6.0258      0.9325        0.6246    0.0794

===============================
Row 3==> Total_Chl_cm2, proportion 0.624638 >= 0.50 
Row 2==> cells.cm2, proportion 0.900896 >= 0.50 

VIF values:
Total_Chl_cm2     cells.cm2 
     1.120755      1.120755 

Condition indices are all < 30 so they are not significant multicollinearlity issues. For variance-decomposition proportions, all pass assumptions and VIF values <5. No variables observing multicollinearity.

Make combined sym and chl variable
```{r}
# add back in timepoint
subset_df <- master %>%
  dplyr::select(Sym_AFDW.mg.cm2, 
         Total_Chl_cm2, 
         cells.cm2, timepoint)

# Assuming your dataframe is called 'df', scale variables
#subset_df$host_sym_combined <- scale(subset_df$host_prot_mg.cm2) + scale(subset_df$cells.cm2)
```


Run ordinal logistic regression for oogenesis and spermatogeneis stages
```{r}
# Assume you have two dataframes: oogenesis_data and spermatogenesis_data
# Adding a new column to identify the process
oogenesis_data <- oogen_abundance %>%
  mutate(Process = "Oogenesis")

spermatogenesis_data <- sperm_abundance %>%
  mutate(Process = "Spermatogenesis")

# Combine the two datasets
combined_data <- bind_rows(oogenesis_data, spermatogenesis_data)

# Make Stage is an ordered factor
combined_data$Stage <- factor(combined_data$Stage, ordered = TRUE, 
                   levels = c("Stage 0", "Stage I", "Stage II", "Stage III", "Stage IV", "Stage V"))

# Convert timepoint to factor for both dfs
combined_data$timepoint <- factor(combined_data$timepoint, 
                       levels = c("January", "February", "March", "April", "May", "June", 
                                  "July", "August", "September", "October", "November", "December"))

#make phys timepoints undercase
subset_df$timepoint <- sapply(subset_df$timepoint, function(x) {
  paste0(toupper(substr(x, 1, 1)), tolower(substr(x, 2, nchar(x))))
})

# Convert timepoint to a factor
subset_df$timepoint <- factor(subset_df$timepoint, 
                       levels = c("January", "February", "March", "April", "May", "June", 
                                  "July", "August", "September", "October", "November", "December"))

# Rename the chl_cells column
#subset_df <- subset_df %>%
  #rename_with(~ "host_sym_combined", matches("host_sym_combined"))

# Create a weight variable based on frequency
combined_data$weight <- combined_data$freq * 100  # Multiply by 100 to convert to whole numbers

# First, let's check the unique values in the timepoint column
print(unique(subset_df$timepoint))

# Make sure timepoint is a factor with all levels
all_months <- c("January", "February", "March", "April", "May", "June", 
                "July", "August", "September", "October")
# make factor
subset_df$timepoint <- factor(subset_df$timepoint, levels = all_months)

# Merge phys timeseries and repo 
merged_data <- merge(subset_df, combined_data, by = "timepoint", all = TRUE)

# Rename chl_cells column
#names(merged_data)[names(merged_data) == "host_sym_combined[, 1]"] <- "host_sym_combined"

# Make Stage as an ordered factor
merged_data$Stage <- factor(merged_data$Stage, ordered = TRUE, 
                            levels = c("Stage 0", "Stage I", "Stage II", "Stage III", "Stage IV", "Stage V"))


# Scale all phys variables
#merged_data$Host_AFDW.mg.cm2 <- scale(merged_data$Host_AFDW.mg.cm2)
#merged_data$host_prot_mg.cm2 <- scale(merged_data$host_prot_mg.cm2)
merged_data$Sym_AFDW.mg.cm2 <- scale(merged_data$Sym_AFDW.mg.cm2)
merged_data$Total_Chl_cm2 <- scale(merged_data$Total_Chl_cm2)
merged_data$cells.cm2 <- scale(merged_data$cells.cm2)


# Run ordinal logistic regressions separately for each gametogenic process
oogenesis_data <- subset(merged_data, Process == "Oogenesis")
spermatogenesis_data <- subset(merged_data, Process == "Spermatogenesis")

# # Run oogenesis model
# oogenesis_model <- polr(Stage ~ Host_AFDW.mg.cm2 + Sym_AFDW.mg.cm2 + 
#                         host_prot_mg.cm2 + chl_cells_combined, 
#                         data = oogenesis_data, Hess = TRUE, weights = weight)
# 
# 
# summary(oogenesis_model)
# 
# # testing parallel regression assumption using Brant's test
# brant(oogenesis_model)
# 
# # Run spermatogenesis model
# spermatogenesis_model <- polr(Stage ~ Host_AFDW.mg.cm2 + Sym_AFDW.mg.cm2 + 
#                               host_prot_mg.cm2 + chl_cells_combined, 
#                               data = spermatogenesis_data, Hess = TRUE, weights = weight)
# 
# summary(spermatogenesis_model)
# 
# # testing parallel regression assumption using Brant's test
# brant(spermatogenesis_model)
# 
# # Assuming you have the model results saved as "model"
# library(ggplot2)
# library(broom)
# 
# # Tidy the model results
# model_coefs <- tidy(model, conf.int = TRUE)
# 
# # Filter out the intercepts for a cleaner plot
# model_coefs <- model_coefs[!grepl("\\|", model_coefs$term), ]
# 
# # Plot the coefficients
# ggplot(model_coefs, aes(x = term, y = estimate)) +
#   geom_point() +
#   geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
#   coord_flip() +
#   theme_minimal() +
#   labs(title = "Coefficient Plot for Partial Proportional Odds Model",
#        x = "Predictors", y = "Coefficient Estimate") +
#   geom_hline(yintercept = 0, linetype = "dashed", color = "red")



```
Do not meet assumptions of the Brant's test and show variable relationships with stages, try a partial proportional odds model

For oogenesis use a generalized orgered logit model
```{r}
# Fit the generalized ordered logistic regression
oogen_model <- vglm(Stage ~ cells.cm2 + Sym_AFDW.mg.cm2 + Total_Chl_cm2,
              family = cumulative(parallel = FALSE, reverse = TRUE),
              data = oogenesis_data, weights = weight)

# Summary of the model
summary(oogen_model)

# Extract coefficients from the model into a dataframe
coef_df_oogen <- data.frame(
  coef = coef(oogen_model),
  variable = names(coef(oogen_model))
)

# Calculate the odds ratio from the coefficients
coef_df_oogen$odd.ratio <- exp(coef_df_oogen$coef)

# Separate variable name and stage, and update variable names
coef_df_oogen <- coef_df_oogen %>%
  separate(variable, into = c("variable", "stage"), sep = ":") %>%
  filter(variable != "(Intercept)") %>%
  mutate(
    stage = as.numeric(stage),
    variable = case_when(
      variable == "cells.cm2" ~ "Symbiont Densities",
      #variable == "host_prot_mg.cm2" ~ "Host Protein",
      #variable == "Host_AFDW.mg.cm2" ~ "Host Biomass",
      variable == "Total_Chl_cm2" ~ "Total Chlorophyll",
      variable == "Sym_AFDW.mg.cm2" ~ "Symbiont Biomass",
      TRUE ~ variable
    )
  ) %>%
  # Reorder variables
  mutate(variable = factor(variable, levels = c("Symbiont Densities", "Total Chlorophyll", "Symbiont Biomass")))

# Replace numeric stages with Roman numerals
coef_df_oogen <- coef_df_oogen %>%
  mutate(stage = case_when(
    stage == 1 ~ "I",
    stage == 2 ~ "II",
    stage == 3 ~ "III",
    stage == 4 ~ "IV",
    stage == 5 ~ "V"),
  percent_increase = ifelse(odd.ratio > 1, (odd.ratio - 1) * 100, NA))  # Calculate percent increase where odds ratio > 1

# Create the plot
oogen_plot <- ggplot(coef_df_oogen, aes(x = factor(stage), y = odd.ratio, fill = variable)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") +
  geom_vline(xintercept = 1.5:5.5, color = "gray50", linetype = "solid") +
  # Add percentage labels for bars with odds ratio > 1
  geom_text(aes(label = ifelse(!is.na(percent_increase), paste0("+", round(percent_increase, 1), "%"), "")), 
            position = position_dodge(width = 0.8), vjust = -0.5, size = 8) +
  ylim(0,3) +
  # PNW color palette
  scale_fill_manual(values = c("#0072B2", "#009E73", "#D55E00")) +
  labs(x = "Oogenesis Stage", 
       y = expression("Odds Ratio (" * italic(e)^coefficient * ")")) + # Y-axis label with italicized e
       #title = "Effects of Physiological Variables on Oogenesis Stages",
       #fill = "Physiological Variable")) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 30),
    axis.text.y = element_text(size = 30),
    axis.title = element_text(size = 30),
    plot.title = element_text(size = 32),
    legend.position = "none",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA)); oogen_plot


# Save sperm plot with increased size and resolution
ggsave("gametogenesis_timeseries_analysis/Figures/oogenesis_phys_model_plot.png", 
       plot = oogen_plot, 
       width = 10, 
       height = 8, 
       dpi = 300, 
       units = "in")

```

For spermatogenesis
```{r}
# Fit the generalized ordered logistical regression model

spermatogenesis_data_clean <- na.omit(spermatogenesis_data)


spermatogenesis_data_clean$Stage <- factor(spermatogenesis_data_clean$Stage, 
                                           levels = c("Stage 0", "Stage I", "Stage II", "Stage III", "Stage IV", "Stage V"), 
                                           ordered = TRUE)

# List of physiological variables to scale
phys_vars <- c("cells.cm2", "Sym_AFDW.mg.cm2", "Total_Chl_cm2")

spermatogenesis_data_clean <- spermatogenesis_data_clean[spermatogenesis_data_clean$weight > 0, ]

# Scale the variables
spermatogenesis_data_clean[phys_vars] <- lapply(spermatogenesis_data_clean[phys_vars], scale)

sperm_model <- vglm(Stage ~ Sym_AFDW.mg.cm2 + 
              cells.cm2 + Total_Chl_cm2,
              family = cumulative(parallel = FALSE, reverse = TRUE),
              data = spermatogenesis_data_clean)

# Summary of the model
summary(sperm_model)


# Extract coefficients
coef_df_sperm <- data.frame(
  coef = coef(sperm_model),
  variable = names(coef(sperm_model))
)

# Calculate the odds ratio from the coefficients
coef_df_sperm$odd.ratio <- exp(coef_df_sperm$coef)

# Separate variable name and stage, and update variable names
coef_df_sperm <- coef_df_sperm %>%
  separate(variable, into = c("variable", "stage"), sep = ":") %>%
  filter(variable != "(Intercept)") %>%
  mutate(
    stage = as.numeric(stage),
    variable = case_when(
      variable == "cells.cm2" ~ "Symbiont Densities",
      #variable == "host_prot_mg.cm2" ~ "Host Protein",
      #variable == "Host_AFDW.mg.cm2" ~ "Host Biomass",
      variable == "Total_Chl_cm2" ~ "Total Chlorophyll",
      variable == "Sym_AFDW.mg.cm2" ~ "Symbiont Biomass",
      TRUE ~ variable
    )
  ) %>%
  # Reorder variables
  mutate(variable = factor(variable, levels = c("Symbiont Densities", "Total Chlorophyll", "Symbiont Biomass")))

# Replace numeric stages with Roman numerals
coef_df_sperm <- coef_df_sperm %>%
  mutate(stage = case_when(
    stage == 1 ~ "I",
    stage == 2 ~ "II",
    stage == 3 ~ "III",
    stage == 4 ~ "IV",
    stage == 5 ~ "V"),
  percent_increase = ifelse(odd.ratio > 1, (odd.ratio - 1) * 100, NA))  # Calculate percent increase where odds ratio > 1


# Create the plot with increased text sizes
# Create the plot with increased text sizes and percent labels above the bars
sperm_plot <- ggplot(coef_df_sperm, aes(x = factor(stage), y = odd.ratio, fill = variable)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") +
  geom_vline(xintercept = 1.5:5.5, color = "gray50", linetype = "solid") +
  # Add percentage labels for bars with odds ratio > 1
  geom_text(aes(label = ifelse(!is.na(percent_increase), paste0("+", round(percent_increase, 1), "%"), "")), 
            position = position_dodge(width = 0.8), vjust = -0.5, size = 8) +
  # PNW color palette
  scale_fill_manual(values = c("#0072B2", "#009E73", "#D55E00")) +
  labs(x = "Spermatogenesis Stage", 
       y = expression("Odds Ratio (" * italic(e)^coefficient * ")"),  # Y-axis label with italicized e
       #title = "Effects of Physiological Variables on Spermatogenesis Stages",
       fill = "Physiological Variable") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 30),
    axis.text.y = element_text(size = 30),
    axis.title = element_text(size = 30),
    plot.title = element_text(size = 32),
    legend.title = element_text(size = 30),
    legend.text = element_text(size = 26),
    legend.position = "bottom",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA)); sperm_plot

# Save sperm plot with increased size and resolution
ggsave("gametogenesis_timeseries_analysis/Figures/spermatogenesis_phys_model_plot.png", 
       plot = sperm_plot, 
       width = 12, 
       height = 8, 
       dpi = 300, 
       units = "in")

```


# Combine spermato and oogen size plots with patchwork
```{r}
# Combine plots using patchwork with a shared x-axis, tags, and centered axis labels
combined_plot_odds <- (oogen_plot / sperm_plot) +
  plot_annotation(tag_levels = 'A') &
  theme(
    plot.tag = element_text(size = 50, face = "bold")  # Adjust tag text style here
  ) +
  plot_layout(guides = "collect")  # Collect the legends at the combined level

# Save the combined plot
ggsave("gametogenesis_timeseries_analysis/Figures/combined_odds_ratio_plots.png", combined_plot_odds, width = 20, height = 20)
```
