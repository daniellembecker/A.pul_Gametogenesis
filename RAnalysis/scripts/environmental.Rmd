---
title: "environmental_processing"
author: "daniellembecker"
date: "2024-04-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Processing all environmental data collected from Mahana site in Moorea, French Polynesia (continuous light and temperature data) from ~January till November 2022

##Install packages
# load packages

```{r}
library("segmented")
library("devtools")
library("plotrix")
library("gridExtra")
library("LoLinR")
library("lubridate")
library('tidyverse')
library('lubridate')
library('scales')

```

##Processing temperature data for from HOBO temperature loggers out at Mahana from January to November

#load temp data

```{r}
mahana.temp.hobo.06 <- read.csv("RAnalysis/data/HOBO/April2022_mahana_loggers/Mahana_6.csv")
mahana.temp.hobo.09 <- read.csv("RAnalysis/data/HOBO/April2022_mahana_loggers/Mahana_9.csv")
mahana.temp.hobo.07 <- read.csv("RAnalysis/data/HOBO/April2022_mahana_loggers/20444028_Mahana_7.csv")
mahana.temp.hobo.10 <- read.csv("RAnalysis/data/HOBO/November2022_mahana_loggers/20221114_Mahana_10.csv")
mahana.temp.hobo.11 <- read.csv("RAnalysis/data/HOBO/November2022_mahana_loggers/20221114_Mahana_11.csv")
mahana.temp.hobo.12 <- read.csv("RAnalysis/data/HOBO/November2022_mahana_loggers/20221114_Mahana_12.csv")
mahana.temp.hobo.13 <- read.csv("RAnalysis/data/HOBO/November2022_mahana_loggers/20221114_Mahana_13.csv")
mahana.temp.hobo.08 <- read.csv("RAnalysis/data/HOBO/November2022_mahana_loggers/20221114_Mahana_8.csv")
mahana.temp.hobo.05 <- read.csv("RAnalysis/data/HOBO/November2022_mahana_loggers/20221114_Mahana_5.csv")
mahana.temp.hobo.04 <- read.csv("RAnalysis/data/HOBO/November2022_mahana_loggers/20221114_Mahana_4.csv")
mahana.temp.hobo.03 <- read.csv("RAnalysis/data/HOBO/November2022_mahana_loggers/20221114_Mahana_3.csv")
mahana.temp.hobo.02 <- read.csv("RAnalysis/data/HOBO/November2022_mahana_loggers/20221114_Mahana_2.csv")
```


#bind all data sets together into one data frame

```{r}
temp.data <- rbind(mahana.temp.hobo.02, mahana.temp.hobo.03, mahana.temp.hobo.04, mahana.temp.hobo.05, mahana.temp.hobo.06, mahana.temp.hobo.07, mahana.temp.hobo.08, mahana.temp.hobo.09, mahana.temp.hobo.10, mahana.temp.hobo.11, mahana.temp.hobo.12, mahana.temp.hobo.13)
```


#remove any NA's from the data frame
```{r}
temp.data <- na.omit(temp.data)

view(temp.data)
```

#modify the date and time structure

```{r}
temp.data$date.time <- mdy_hm(temp.data$date.time, quiet=FALSE, tz="UTC", truncated=0) #format date and time
```
 

#save file as csv so transforms to data frame
```{r}
write.csv(temp.data, 'RAnalysis/output/environmental/20240129_mahana_temp_data.csv')
```
 

#make logger number a factor
```{r}
temp.data$logger.number = as.factor(temp.data$logger.number)
```


#subset temp data for mean across loggers
```{r}
# Separate date and temperature from the "date.temp" column
temp.data.sep <- temp.data %>%
  separate(date.time, into = c("date", "time"), sep = " ")

# Convert Temp to numeric
temp.data.sep$temp <- as.numeric(temp.data.sep$temp)

# Group by Date and calculate the mean temperature for each day
mean_temp_per_day <- temp.data.sep %>%
  group_by(date) %>%
  summarise(mean_temp = mean(temp))

# Assuming your "date" column is not yet of class Date
mean_temp_per_day$date <- as.Date(mean_temp_per_day$date)

filtered_data <- mean_temp_per_day %>%
  filter((date >= as.Date("2022-01-24") & date <= as.Date("2022-11-04")))

filtered_data <- filtered_data %>%
  filter(date != as.Date("2022-08-07"))

```


#plot data by hobo logger per every 4 days no average

```{r}

# plot data for temp change every four days
temp.plot <- filtered_data %>%
  ggplot(aes(x=date, y=mean_temp))+
  geom_line() + 
  geom_point() +
  scale_x_date(date_breaks = "4 day", date_labels = "%m-%d") +
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90)) +
  ylab("Temperature (°C)")+
  xlab("Date")+
  theme(axis.title = element_text(size = 16),   # Adjust the size of x and y axis labels
        axis.text = element_text(size = 16)) ;temp.plot

ggsave(filename="RAnalysis/output/environmental/20240129_temp_logger_plot.pdf", plot=temp.plot, width=30, height=10, units="in")

ggsave(filename="RAnalysis/output/environmental/20240129_temp_logger_plot.png", plot=temp.plot, width=20, height=10, units="in")
```

# plot temeprature mean sea surface temp per month
```{r}

# Calculate mean sea surface temperature per month
temp.data$month <- factor(month(temp.data$date.time), levels = 1:12, labels = month.abb)  # Extract month from date as factor

#group data by month and summarise for mean temp per month
mean_temp_per_month <- temp.data %>%
  group_by(month) %>%
  summarise(mean_temp = mean(temp, na.rm = TRUE)) %>%
  arrange(match(month, month.abb))  # Sort the data by month in ascending order

# Plot mean sea surface temperature per month as a dot and line plot
temp.month <- ggplot(mean_temp_per_month, aes(x = as.numeric(month), y = mean_temp)) +
  geom_point(size = 3, color = "black") +
  geom_line(color = "black") +  # Specify the color for the line
  ylab("Mean Sea Surface Temperature (°C)") +
  xlab("Month") +
  theme_classic() +
  scale_x_continuous(breaks = 1:12, labels = month.abb) + # Treat month as continuous
  ylim(NA, 29)  # Adjust the y-axis limits as needed

temp.month

# save mean temp per month plot
ggsave("RAnalysis/output/environmental/mean.temp.month.pdf", temp.month , width = 10, height = 6)
ggsave("RAnalysis/output/environmental/mean.temp.month.jpg", temp.month , width = 10, height = 6)


```


##Processing continuous light data for from Odyssey light loggers out at Mahana from March - October

#load light data

```{r}
odyssey.1 <- read.csv("RAnalysis/data/HOBO/odyssey_light_loggers/15640_001_003.csv")
odyssey.2 <- read.csv("RAnalysis/data/HOBO/odyssey_light_loggers/15641_001_003.csv")

```


```{r}
odyssey.1 <- read.csv("RAnalysis/data/HOBO/odyssey_light_loggers/15640_001_003.csv")
odyssey.2 <- read.csv("RAnalysis/data/HOBO/odyssey_light_loggers/15641_001_003.csv")

```

#bind all data sets together into one data frame

```{r}
light.data <- rbind(odyssey.1, odyssey.2)
```


#remove any NA's from the data frame
```{r}
light.data <- na.omit(light.data)

view(light.data)
```


```{r}
# Combine Date and Time columns into a new column named DateTime
light.data$DateTime <- with(light.data, {
  dmy_hms(paste(date, time), truncated = 2)  # truncated = 2 allows for two-digit years
})

# Separate date and time from the "date.temp" column
light.data.sep <- light.data %>%
  separate(DateTime, into = c("Date", "Time"), sep = " ")

# Assuming your "Date" column is in a character format
light.data.sep$Date <- as.Date(light.data.sep$Date, format = "%Y-%m-%d")

# Group by Date and calculate the mean temperature for each day
mean_light_per_day <- light.data.sep %>%
  group_by(Date) %>%
  summarise(mean_light = mean(calibrated))

```

```{r}
#compare  light across timeseries

light.plot <- mean_light_per_day %>%
  ggplot(aes(x = Date, y = mean_light)) +
  geom_line() + 
  geom_point() +
  scale_x_date(date_breaks = "4 days", date_labels = "%m-%d") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 90, size = 16),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 16)) +
  xlab("Date") +
  ylab(expression(atop("Light Intensity", (mu*mol~m^{-2}~s^{-1})))); light.plot


ggsave(filename="RAnalysis/output/environmental/20240129_light_logger_plot.pdf", plot=light.plot, width=30, height=10, units="in")

ggsave(filename="RAnalysis/output/environmental/20240129_light_logger_plot.png", plot=light.plot, width=20, height=10, units="in")

```

# plot light mean light per month
```{r}

# Calculate mean sea surface temperature per month
light.data$month <- factor(month(light.data$DateTime), levels = 1:12, labels = month.abb)  # Extract month from date as factor

#group data by month and summarise for mean temp per month
mean_light_per_month <- light.data %>%
  group_by(month) %>%
  summarise(mean_light = mean(calibrated, na.rm = TRUE)) %>%
  arrange(match(month, month.abb))  # Sort the data by month in ascending order

# Plot mean sea surface temperature per month as a dot and line plot
light.month <- ggplot(mean_light_per_month, aes(x = as.numeric(month), y = mean_light)) +
  geom_point(size = 3, color = "black") +
  geom_line(color = "black") +  # Specify the color for the line
  ylab("Mean Sea Surface Temperature (°C)") +
  xlab("Month") +
  theme_classic() +
  scale_x_continuous(breaks = 1:12, labels = month.abb) + # Treat month as continuous
  ylim(NA, 4500)  # Adjust the y-axis limits as needed

light.month

# save mean temp per month plot
ggsave("RAnalysis/output/environmental/mean.light.month.pdf", light.month , width = 10, height = 6)
ggsave("RAnalysis/output/environmental/mean.light.month.jpg", light.month , width = 10, height = 6)


```

# Make a commbined plot of light and temperature

```{r}
# Combine light and temperature data

# rename date column to Date in mean_temp_per_day
#mean_temp_per_day <- mean_temp_per_day %>%
 # rename(Date = date)

# make combined data file
#combined_data <- full_join(mean_light_per_day, mean_temp_per_day, by = "Date")

#make combined data by month
# Assuming 'mean_light_per_month' and 'mean_temp_per_month' are your data frames with mean values per month for light intensity and temperature, respectively

# Joining the data frames
mean_monthly_data <- full_join(mean_light_per_month, mean_temp_per_month, by = "month")

# Remove NAs only from mean_light column
mean_monthly_data_light <- mean_monthly_data[!is.na(mean_monthly_data$mean_light), ]

# Plotting code
ggplot(mean_monthly_data, aes(x = month)) +
  geom_point(aes(y = mean_temp, color = "Temperature", group = 1), size = 3) +  # Add points for temperature
  geom_line(aes(y = mean_temp, color = "Temperature", group = 1)) +  # Add lines for temperature
  geom_point(aes(y = mean_light / 250 + 18, color = "Light Intensity", group = 1), size = 3) +  # Add points for light intensity
  geom_line(aes(y = mean_light  / 250 + 18, color = "Light Intensity", group = 1)) +  # Add lines for light intensity
  scale_y_continuous(
    sec.axis = sec_axis(~ . * 250, name = "Light Intensity") , name = "Mean Sea Surface Temperature (°C)",
    limits = c(26, 29)) + # Set limits for the primary y-axis)) 
  scale_color_manual(values = c("Temperature" = "black", "Light Intensity" = "grey")) +  # Set colors
  labs(x = "Month", y = NULL) +
  theme_classic() +
  theme(
    axis.title.y = element_text(color = "black", size = 13),
    axis.title.y.right = element_text(color = "grey", size = 13),
    axis.text.y.right = element_text(color = "grey", size = 13)
  )









```

