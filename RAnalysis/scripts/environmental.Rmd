---
title: "environmental_processing"
author: "daniellembecker"
date: "2024-04-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Processing all environmental data collected from Mahana site in Moorea, French Polynesia (continuous light and temperature data) from ~January till November 2022

##Install packages
# load packages

```{r}
library("segmented")
library("devtools")
library("plotrix")
library("gridExtra")
# Install devtools if not already installed
if (!require("devtools")) install.packages("devtools")
# Load devtools
library(devtools)
# Install LoLinR from GitHub
devtools::install_github("colin-olito/LoLinR")
library("LoLinR")
library("lubridate")
library('tidyverse')
library('lubridate')
library('scales')
library('patchwork')

```

##Processing temperature data for from HOBO temperature loggers out at Mahana from January to November

#load temp data

```{r}
mahana.temp.hobo.06 <- read.csv("RAnalysis/data/environmental/HOBO_temperature/20220415_Mahana_6.csv")
mahana.temp.hobo.09 <- read.csv("RAnalysis/data/environmental/HOBO_temperature/20220415_Mahana_9.csv")
mahana.temp.hobo.07 <- read.csv("RAnalysis/data/environmental/HOBO_temperature/20220415_Mahana_7.csv")
mahana.temp.hobo.10 <- read.csv("RAnalysis/data/environmental/HOBO_temperature/20221114_Mahana_10.csv")
mahana.temp.hobo.11 <- read.csv("RAnalysis/data/environmental/HOBO_temperature/20221114_Mahana_11.csv")
mahana.temp.hobo.12 <- read.csv("RAnalysis/data/environmental/HOBO_temperature/20221114_Mahana_12.csv")
mahana.temp.hobo.13 <- read.csv("RAnalysis/data/environmental/HOBO_temperature/20221114_Mahana_13.csv")
mahana.temp.hobo.08 <- read.csv("RAnalysis/data/environmental/HOBO_temperature/20221114_Mahana_8.csv")
mahana.temp.hobo.05 <- read.csv("RAnalysis/data/environmental/HOBO_temperature/20221114_Mahana_5.csv")
mahana.temp.hobo.04 <- read.csv("RAnalysis/data/environmental/HOBO_temperature/20221114_Mahana_4.csv")
mahana.temp.hobo.03 <- read.csv("RAnalysis/data/environmental/HOBO_temperature/20221114_Mahana_3.csv")
mahana.temp.hobo.02 <- read.csv("RAnalysis/data/environmental/HOBO_temperature/20221114_Mahana_2.csv")
```


#bind all data sets together into one data frame

```{r}
temp.data <- rbind(mahana.temp.hobo.02, mahana.temp.hobo.03, mahana.temp.hobo.04, mahana.temp.hobo.05, mahana.temp.hobo.06, mahana.temp.hobo.07, mahana.temp.hobo.08, mahana.temp.hobo.09, mahana.temp.hobo.10, mahana.temp.hobo.11, mahana.temp.hobo.12, mahana.temp.hobo.13)
```


#remove any NA's from the data frame
```{r}
temp.data <- na.omit(temp.data)

view(temp.data)
```

#modify the date and time structure

```{r}
temp.data$date.time <- mdy_hm(temp.data$date.time, quiet=FALSE, tz="UTC", truncated=0) #format date and time
```


#make logger number a factor
```{r}
temp.data$logger.number = as.factor(temp.data$logger.number)
```


#subset temp data for mean across loggers
```{r}
# Separate date and temperature from the "date.temp" column
temp.data.sep <- temp.data %>%
  separate(date.time, into = c("date", "time"), sep = " ")

# Convert Temp to numeric
temp.data.sep$temp <- as.numeric(temp.data.sep$temp)

# Group by Date and calculate the mean temperature for each day
mean_temp_per_day <- temp.data.sep %>%
  group_by(date) %>%
  summarise(mean_temp = mean(temp))

# Assuming your "date" column is not yet of class Date
mean_temp_per_day$date <- as.Date(mean_temp_per_day$date)

filtered_data <- mean_temp_per_day %>%
  filter((date >= as.Date("2022-01-24") & date <= as.Date("2022-10-31")))

filtered_data <- filtered_data %>%
  filter(date != as.Date("2022-08-07"))

```


#plot data by hobo logger per every 4 days no average

```{r}

# plot data for temp change every four days
temp.plot <- filtered_data %>%
  ggplot(aes(x=date, y=mean_temp))+
  geom_line() + 
  geom_point() +
  scale_x_date(date_breaks = "4 day", date_labels = "%m-%d") +
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90)) +
  ylab("Temperature (°C)")+
  xlab("Date")+
  theme(axis.title = element_text(size = 16),   # Adjust the size of x and y axis labels
        axis.text = element_text(size = 16)) ;temp.plot

#ggsave(filename="RAnalysis/output/environmental/20240129_temp_logger_plot.pdf", plot=temp.plot, width=30, height=10, units="in")

ggsave(filename="RAnalysis/output/environmental/20240129_temp_logger_plot.png", plot=temp.plot, width=20, height=10, units="in")
```




# plot temeprature mean sea surface temp per month
```{r}
# Calculate mean sea surface temperature per month
temp.data$month <- factor(month(temp.data$date.time), levels = 1:12, labels = month.abb)  # Extract month from date as factor

#filter to not show november 
temp.dat <- temp.data %>%
  filter(month != "Nov")

#group data by month and summarise for mean temp per month
mean_temp_per_month <- temp.dat %>%
  group_by(month) %>%
  summarise(mean_temp = mean(temp, na.rm = TRUE)) %>%
  arrange(match(month, month.abb))  # Sort the data by month in ascending order

# Plot mean sea surface temperature per month as a dot and line plot
temp.month <- ggplot(mean_temp_per_month, aes(x = as.numeric(month), y = mean_temp)) +
  geom_point(size = 3, color = "black") +
  geom_line(color = "black") +  # Specify the color for the line
  ylab("Mean Sea Surface Temperature (°C)") +
  xlab("Month") +
  theme_classic() +
  scale_x_continuous(breaks = 1:12, labels = month.abb) + # Treat month as continuous
  ylim(NA, 29)  # Adjust the y-axis limits as needed

temp.month

# save mean temp per month plot
#ggsave("RAnalysis/output/environmental/mean.temp.month.pdf", temp.month , width = 10, height = 6)
ggsave("RAnalysis/output/environmental/mean.temp.month.png", temp.month , width = 10, height = 6)


```


# plot temeprature mean sea surface temp per month with variation around
```{r}
# Ensure data only contains January to October
temp.dat <- temp.dat %>%
  filter(month(date.time) %in% 1:10)  # Filter to keep only January to October

# Make smoothed line plot
temp_summary_plot <- temp.dat %>%
  ggplot(aes(x = date.time, y = temp)) + 
  geom_point(colour = "gray", size = 0.5, alpha = 0.05) + 
  geom_smooth(se = FALSE, method = "gam", colour = "black") + 
  ylab("Temperature °C") + 
  xlab("Date") +
  scale_x_datetime(date_breaks = "1 month", date_labels = "%b %Y", 
                   limits = c(as.POSIXct("2022-01-25"), as.POSIXct("2022-10-31"))) +
  theme_classic() + 
  theme(text = element_text(size = 14, colour = "black"), 
    axis.title = element_text(size = 18, colour = "black", face = "bold"), 
    axis.text.x = element_text(size = 14, colour = "black", angle = 45, hjust = 1, vjust = 1),
    legend.title = element_text(size = 18, colour = "black", face = "bold")) + 
  ylim(25, 30);temp_summary_plot

# save mean temp per month plot
ggsave("RAnalysis/output/environmental/temp_summary_plot.png", temp_summary_plot , width = 10, height = 6)

write.csv(temp.data, "gametogenesis_timeseries/gametogenesis_timeseries_analysis/Output/mean_temp_data.csv")


```

##Processing continuous light data for from Odyssey light loggers out at Mahana from March - October

#load light data

```{r}
odyssey.1 <- read.csv("RAnalysis/data/environmental/odyssey_light_loggers/15640_001_003.csv")
odyssey.2 <- read.csv("RAnalysis/data/environmental/odyssey_light_loggers/15641_001_003.csv")

```


```{r}
odyssey.1 <- read.csv("RAnalysis/data/environmental/odyssey_light_loggers/15640_001_003.csv")
odyssey.2 <- read.csv("RAnalysis/data/environmental/odyssey_light_loggers/15641_001_003.csv")

```

#bind all data sets together into one data frame

```{r}
light.data <- rbind(odyssey.1, odyssey.2)
```


#remove any NA's from the data frame
```{r}
light.data <- na.omit(light.data)

view(light.data)
```


```{r}
# Combine Date and Time columns into a new column named DateTime
light.data$DateTime <- with(light.data, {
  dmy_hms(paste(date, time), truncated = 2)  # truncated = 2 allows for two-digit years
})

# Separate date and time from the "date.temp" column
light.data.sep <- light.data %>%
  separate(DateTime, into = c("Date", "Time"), sep = " ")

# Assuming your "Date" column is in a character format
light.data.sep$Date <- as.Date(light.data.sep$Date, format = "%Y-%m-%d")

# remove first two columns
light.data.save <- light.data.sep %>%
  dplyr::select(-date, -time, -raw)

# Group by Date and calculate the mean temperature for each day
mean_light_per_day <- light.data.sep %>%
  group_by(Date) %>%
  summarise(mean_light = mean(calibrated))

# Calculate light per month 
# Convert the Date column to a Date object
light.data.sep$Date <- as.Date(light.data.sep$Date)

# Calculate mean light per month
mean_light_per_month <- light.data.sep %>%
  group_by(month = format(Date, "%Y-%m")) %>%
  summarise(mean_light = mean(calibrated))

```

```{r}
#compare  light across timeseries
light.plot <- mean_light_per_day %>%
  ggplot(aes(x = Date, y = mean_light)) +
  geom_line() + 
  geom_point() +
  scale_x_date(date_breaks = "4 days", date_labels = "%m-%d") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 90, size = 16),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 16)) +
  xlab("Date") +
  ylab(expression(atop("Photosynthetic Photon Flux Density", (mu*mol~photons~m^{-2}~s^{-1})))); light.plot


#ggsave(filename="RAnalysis/output/environmental/20240129_light_logger_plot.pdf", plot=light.plot, width=30, height=10, units="in")

ggsave(filename="RAnalysis/output/environmental/20240129_light_logger_plot.png", plot=light.plot, width=20, height=10, units="in")

```

# plot light mean light per month
```{r}

# Calculate mean sea surface temperature per month
light.data$month <- factor(month(light.data$DateTime), levels = 1:12, labels = month.abb)  # Extract month from date as factor

#group data by month and summarise for mean temp per month
mean_light_per_month <- light.data %>%
  group_by(month) %>%
  summarise(mean_light = mean(calibrated, na.rm = TRUE)) %>%
  arrange(match(month, month.abb))  # Sort the data by month in ascending order

# Plot mean sea surface temperature per month as a dot and line plot
light.month <- ggplot(mean_light_per_month, aes(x = as.numeric(month), y = mean_light)) +
  geom_point(size = 3, color = "black") +
  geom_line(color = "black") +  # Specify the color for the line
  ylab(expression(atop("Photosynthetic Photon Flux Density", (mu*mol~photons~m^{-2}~s^{-1})))) +
  xlab("Month") +
  theme_classic() +
  scale_x_continuous(breaks = 1:12, labels = month.abb) + # Treat month as continuous
  ylim(NA, 4500)  # Adjust the y-axis limits as needed

light.month

# save mean temp per month plot
#ggsave("RAnalysis/output/environmental/mean.light.month.pdf", light.month , width = 10, height = 6)
ggsave("RAnalysis/output/environmental/mean.light.month.png", light.month , width = 10, height = 6)

```


# plot light per month with variation
```{r}
# Plot mean sea surface temperature per month with variation around the mean
light_summary_plot <- light.data %>%
  ggplot(., aes(x = DateTime, y = calibrated)) + 
  geom_point(colour = "darkgray", size = 0.5, alpha = 0.05) + 
  geom_smooth(aes(), se = FALSE, colour = "black") + 
  ylab(expression(atop("Photosynthetic Photon Flux Density", (mu*mol~photons~m^{-2}~s^{-1})))) +
  xlab("Date") +
  scale_x_datetime(date_breaks = "1 months", date_labels = "%b %Y") +
  theme_classic() + 
  theme(
    text = element_text(size = 12, colour = "black"), 
    axis.title = element_text(size = 14, colour = "black", face = "bold"), 
    axis.text.x = element_text(size = 10, colour = "black", angle = 45, hjust = 1, vjust = 1),
    legend.title = element_text(size = 14, colour = "black", face = "bold")) +
    scale_y_continuous(expand = c(0, 0)) +
    coord_cartesian(ylim = c(1000, 6000))

light_summary_plot

# save mean temp per month plot
#ggsave("RAnalysis/output/environmental/light_summary_plot.pdf", light_summary_plot , width = 10, height = 6)
ggsave("RAnalysis/output/environmental/light_summary_plot.png", light_summary_plot , width = 10, height = 6)

write.csv(light.data, "gametogenesis_timeseries/gametogenesis_timeseries_analysis/Output/mean_light_data.csv")

```

# Make a commbined plot of light and temperature

```{r}
# Combine light and temperature data dual axes
# Joining the data frames
mean_monthly_data <- full_join(mean_light_per_month, mean_temp_per_month, by = "month")

# Remove NAs only from mean_light column
mean_monthly_data_light <- mean_monthly_data[!is.na(mean_monthly_data$mean_light), ]

# Plotting code
light.temp <- ggplot(mean_monthly_data, aes(x = month)) +
  geom_point(aes(y = mean_temp, color = "Temperature", group = 1), size = 3) +  # Add points for temperature
  geom_line(aes(y = mean_temp, color = "Temperature", group = 1)) +  # Add lines for temperature
  geom_point(aes(y = (mean_light - 2000) / 833 + 26, color = "Light Intensity", group = 1), size = 3) +  # Add points for light intensity
  geom_line(aes(y = (mean_light - 2000) / 833 + 26, color = "Light Intensity", group = 1)) +  # Add lines for light intensity
  scale_y_continuous(
    sec.axis = sec_axis(~ (. - 26) * 833 + 2000, name = expression(atop("Photosynthetic Photon Flux Density", (mu*mol~photons~m^{-2}~s^{-1})))), name = "Temperature (°C)",
    limits = c(26, 29)) + # Set limits for the primary y-axis)) 
  scale_color_manual(values = c("Temperature" = "black", "Light Intensity" = "grey")) +  # Set colors
  labs(x = "Month", y = NULL) +
  theme_classic() +
  labs(color = "Environmental Data") +
  theme(legend.position = ("none"),
    axis.title.y = element_text(color = "black", size = 18),
    axis.text.y = element_text(color = "black", size = 18),
    axis.title.x = element_text(color = "black", size = 18),
    axis.text.x = element_text(color = "black", size = 18),
    axis.title.y.right = element_text(color = "darkgrey", size = 18),
    axis.text.y.right = element_text(color = "darkgrey", size = 18))

light.temp

# save mean temp per month plot
#ggsave("RAnalysis/output/environmental/mean.light.temp.pdf", light.temp , width = 10, height = 6)
ggsave("RAnalysis/output/environmental/mean.light.temp.png", light.temp , width = 10, height = 6)



```





